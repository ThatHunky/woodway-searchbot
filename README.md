# Woodway Searchbot

Телеграм‑бот, що надає зображення порід дерев у відповідь на текстові запити. Він індексує мережеву теку та використовує Google Gemini Flash для аналізу повідомлень.

## Можливості
- Gemini Flash 2.5 через `google-generativeai` для виокремлення ключових слів.
- Нечіткий пошук за актуальним індексом зображень.
- Індексатор розбиває повні шляхи на токени, тому пошук враховує назви папок і файлів.
- Надсилає до пʼяти випадкових фото на запит.
- Працює у Docker та постійно опитує Telegram.

## Налаштування
1. Скопіюйте `.env.example` до `.env` і заповніть облікові дані.
2. Переконайтеся, що мережевий ресурс доступний і змонтований через SMB.
   У Windows можна вказати `SHARE_PATH` як букву диска, наприклад `P:`,
   бот автоматично нормалізує шлях до `P:\`.
   Цей шлях має бути доступний і всередині контейнера. Примонтуйте ресурс у `docker-compose.yml` та
   задайте `SHARE_PATH` на шлях у контейнері, наприклад:

   ```yaml
   services:
     bot:
       volumes:
         - P:\\:/data/share:ro
   ```

   Після цього встановіть `SHARE_PATH=/data/share` у `.env`.
3. Зберіть і запустіть через Docker Compose:

```bash
docker compose up -d
```

Сервіс створить `index.json` у контейнері та оновлюватиме його кожні десять хвилин за замовчуванням.

## Формати зображень
Підтримувані розширення: `.jpg`, `.jpeg`, `.png`, `.webp`, `.bmp`, `.tif`.

## Тестування
Проєкт містить повний набір тестів для всіх компонентів бота. Запустити їх можна декількома способами.

### Локальний запуск
Щоб виконати тести локально, використайте:

```bash
python -m unittest discover -s bot/tests
```

### Запуск у Docker
Щоб запустити тести в контейнері, скористайтеся конфігурацією `docker-compose.test.yml`:

```bash
docker compose -f docker-compose.test.yml up
```

### Структура тестів
- `bot/tests/test_search.py`: тести пошуку
- `bot/tests/test_config.py`: тести завантаження конфігурації
- `bot/tests/test_indexer.py`: тести індексатора
- `bot/tests/test_handlers.py`: тести обробників повідомлень
- `bot/tests/test_gemini.py`: тести клієнта Gemini

Тести використовують обʼєкти‑заглушки, щоб уникнути реальних викликів API під час перевірки.

## Неперервна інтеграція
Репозиторій використовує GitHub Actions для перевірки коду під час кожного pull request. `ci.yml` встановлює залежності через `uv`, інсталює `ruff`, `pytest` та `cyclonedx-bom`. Cosign встановлюється через `sigstore/cosign-installer`. Воркфлоу запускає `ruff` для лінтингу й форматування, виконує юніт‑тести, генерує SBOM командою `cyclonedx-py requirements -o sbom.xml requirements.txt` і підписує його `cosign sign-blob --yes --output-signature sbom.sig sbom.xml`.
